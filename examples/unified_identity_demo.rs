// DIAP Rust SDK - ç»Ÿä¸€èº«ä»½ç®¡ç†æ¼”ç¤º
// å±•ç¤ºå¦‚ä½•ä½¿ç”¨ IdentityManager ç®€åŒ– DID/IPNS æ³¨å†Œå’ŒéªŒè¯æµç¨‹

use diap_rs_sdk::*;
use anyhow::Result;

#[tokio::main]
async fn main() -> Result<()> {
    // åˆå§‹åŒ–æ—¥å¿—
    env_logger::Builder::from_env(env_logger::Env::default().default_filter_or("info")).init();
    
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘   DIAP Rust SDK - ç»Ÿä¸€èº«ä»½ç®¡ç†æ¼”ç¤º                â•‘");
    println!("â•‘   ä¸€é”®å®Œæˆ DID/IPNS æ³¨å†Œå’ŒéªŒè¯                     â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–èº«ä»½ç®¡ç†å™¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ã€ç¬¬ä¸€æ­¥ã€‘åˆå§‹åŒ–èº«ä»½ç®¡ç†å™¨");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    let ipfs_client = IpfsClient::new(
        Some("http://localhost:5001".to_string()),
        Some("http://localhost:8080".to_string()),
        None,  // Pinata API key (å¯é€‰)
        None,  // Pinata API secret (å¯é€‰)
        30,    // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    );
    
    let ipns_publisher = IpnsPublisher::new(
        true,  // ä½¿ç”¨w3name
        true,  // ä½¿ç”¨IPFSèŠ‚ç‚¹
        Some("http://localhost:5001".to_string()),
        365,   // IPNSè®°å½•æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    );
    
    let identity_manager = IdentityManager::new(ipfs_client, ipns_publisher);
    println!("âœ“ èº«ä»½ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ\n");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬äºŒæ­¥ï¼šç”Ÿæˆå¯†é’¥å¯¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ã€ç¬¬äºŒæ­¥ã€‘ç”Ÿæˆå¯†é’¥å¯¹");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    let keypair = KeyPair::generate()?;
    println!("âœ“ å¯†é’¥å¯¹ç”ŸæˆæˆåŠŸ");
    println!("  DID: {}", keypair.did);
    println!("  IPNS Name: {}\n", keypair.ipns_name);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬ä¸‰æ­¥ï¼šå‡†å¤‡æ™ºèƒ½ä½“ä¿¡æ¯
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ã€ç¬¬ä¸‰æ­¥ã€‘å‡†å¤‡æ™ºèƒ½ä½“ä¿¡æ¯");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    let agent_info = AgentInfo {
        name: "æˆ‘çš„å»ä¸­å¿ƒåŒ–æ™ºèƒ½ä½“".to_string(),
        services: vec![
            ServiceInfo {
                service_type: "API".to_string(),
                endpoint: "https://api.myagent.com".to_string(),
            },
            ServiceInfo {
                service_type: "WebSocket".to_string(),
                endpoint: "wss://ws.myagent.com".to_string(),
            },
            ServiceInfo {
                service_type: "DIAP".to_string(),
                endpoint: "https://diap.myagent.com/v1".to_string(),
            },
        ],
        description: Some("ä¸€ä¸ªå¼ºå¤§çš„å»ä¸­å¿ƒåŒ–æ™ºèƒ½ä½“ï¼Œæ”¯æŒå¤šç§åè®®å’ŒæœåŠ¡".to_string()),
        tags: Some(vec![
            "AI".to_string(), 
            "DeFi".to_string(), 
            "Web3".to_string()
        ]),
    };
    
    println!("âœ“ æ™ºèƒ½ä½“ä¿¡æ¯å‡†å¤‡å®Œæˆ");
    println!("  åç§°: {}", agent_info.name);
    println!("  æœåŠ¡æ•°é‡: {}", agent_info.services.len());
    println!("  æ ‡ç­¾: {:?}\n", agent_info.tags);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬å››æ­¥ï¼šä¸€é”®æ³¨å†Œèº«ä»½ï¼ˆDID + IPFS + IPNSï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ã€ç¬¬å››æ­¥ã€‘ä¸€é”®æ³¨å†Œèº«ä»½");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println!("å¼€å§‹æ³¨å†Œæµç¨‹...");
    println!("  â–¸ æ„å»º DID æ–‡æ¡£");
    println!("  â–¸ ä¸Šä¼ åˆ° IPFS");
    println!("  â–¸ æ³¨å†Œ IPNS name");
    println!("  â–¸ æ·»åŠ  IPNS å¼•ç”¨");
    println!("  â–¸ æ›´æ–°å¹¶é‡æ–°å‘å¸ƒ");
    
    let registration = match identity_manager
        .register_identity(&agent_info, &keypair)
        .await 
    {
        Ok(reg) => {
            println!("\nâœ… èº«ä»½æ³¨å†ŒæˆåŠŸï¼");
            println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            println!("â•‘  DID: {:<45}â•‘", reg.did);
            println!("â•‘  IPNS: {:<44}â•‘", reg.ipns_name);
            println!("â•‘  CID: {:<45}â•‘", reg.cid);
            println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            reg
        }
        Err(e) => {
            println!("\nâŒ æ³¨å†Œå¤±è´¥: {}", e);
            println!("\næç¤ºï¼šè¯·ç¡®ä¿ IPFS èŠ‚ç‚¹æ­£åœ¨è¿è¡Œï¼š");
            println!("  $ ipfs daemon");
            return Err(e);
        }
    };
    
    println!("\nğŸ’¾ ä¿å­˜å¯†é’¥åˆ°æœ¬åœ°æ–‡ä»¶...");
    let key_path = std::path::PathBuf::from("./demo_identity.key");
    keypair.save_to_file(&key_path)?;
    println!("âœ“ å¯†é’¥å·²ä¿å­˜åˆ°: {:?}\n", key_path);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬äº”æ­¥ï¼šä¸€é”®éªŒè¯èº«ä»½ï¼ˆé€šè¿‡ IPNS nameï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("ã€ç¬¬äº”æ­¥ã€‘ä¸€é”®éªŒè¯èº«ä»½ï¼ˆé€šè¿‡ IPNSï¼‰");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println!("å¼€å§‹éªŒè¯æµç¨‹...");
    println!("  â–¸ IPNS è§£æ");
    println!("  â–¸ ä¸‹è½½ DID æ–‡æ¡£");
    println!("  â–¸ éªŒè¯ç­¾åå’Œå®Œæ•´æ€§");
    
    let _verification = match identity_manager
        .verify_identity(&registration.ipns_name)
        .await 
    {
        Ok(ver) => {
            println!("\néªŒè¯ç»“æœ: {}", if ver.is_valid { "âœ… æœ‰æ•ˆ" } else { "âŒ æ— æ•ˆ" });
            println!("\néªŒè¯è¯¦æƒ…:");
            for detail in &ver.verification_details {
                println!("  {}", detail);
            }
            ver
        }
        Err(e) => {
            println!("\nâŒ éªŒè¯å¤±è´¥: {}", e);
            return Err(e);
        }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬å…­æ­¥ï¼šé€šè¿‡ DID ç›´æ¥éªŒè¯
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nã€ç¬¬å…­æ­¥ã€‘é€šè¿‡ DID ç›´æ¥éªŒè¯");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    let verification2 = identity_manager
        .resolve_by_did(&registration.did)
        .await?;
    
    println!("âœ“ DID è§£ææˆåŠŸ");
    println!("\næ™ºèƒ½ä½“è¯¦æƒ…:");
    println!("  åç§°: {}", verification2.agent_info.name);
    println!("  æœåŠ¡æ•°é‡: {}", verification2.agent_info.services.len());
    
    if !verification2.agent_info.services.is_empty() {
        println!("\n  æœåŠ¡åˆ—è¡¨:");
        for (i, service) in verification2.agent_info.services.iter().enumerate() {
            println!("    {}. {} â†’ {}", i + 1, service.service_type, service.endpoint);
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ç¬¬ä¸ƒæ­¥ï¼šæ¼”ç¤ºèº«ä»½æ›´æ–°ï¼ˆå¯é€‰ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nã€ç¬¬ä¸ƒæ­¥ã€‘æ¼”ç¤ºèº«ä»½æ›´æ–°");
    println!("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    println!("æ·»åŠ æ–°çš„æœåŠ¡ç«¯ç‚¹...");
    
    let mut updated_agent_info = agent_info.clone();
    updated_agent_info.services.push(ServiceInfo {
        service_type: "GraphQL".to_string(),
        endpoint: "https://graphql.myagent.com".to_string(),
    });
    
    // ä»åŸå§‹æ³¨å†Œç»“æœè·å–åºåˆ—å·
    let current_sequence = if let Some(metadata) = &registration.did_document.ipfs_metadata {
        metadata.sequence
    } else {
        1
    };
    
    match identity_manager
        .update_identity(&updated_agent_info, &keypair, current_sequence)
        .await 
    {
        Ok(updated_reg) => {
            println!("âœ… èº«ä»½æ›´æ–°æˆåŠŸ");
            println!("  æ–° CID: {}", updated_reg.cid);
            println!("  æœåŠ¡æ•°é‡: {}", updated_agent_info.services.len());
        }
        Err(e) => {
            println!("âš ï¸  èº«ä»½æ›´æ–°å¤±è´¥: {}", e);
            println!("ï¼ˆè¿™æ˜¯å¯é€‰åŠŸèƒ½ï¼Œå¤±è´¥ä¸å½±å“æ¼”ç¤ºï¼‰");
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ€»ç»“
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    println!("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘                   æ¼”ç¤ºå®Œæˆï¼                        â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!("\nğŸ“Š æµç¨‹æ€»ç»“ï¼š");
    println!("  1. âœ“ åˆå§‹åŒ–èº«ä»½ç®¡ç†å™¨");
    println!("  2. âœ“ ç”Ÿæˆå¯†é’¥å¯¹");
    println!("  3. âœ“ å‡†å¤‡æ™ºèƒ½ä½“ä¿¡æ¯");
    println!("  4. âœ“ ä¸€é”®æ³¨å†Œèº«ä»½ (DID + IPFS + IPNS)");
    println!("  5. âœ“ ä¸€é”®éªŒè¯èº«ä»½ (é€šè¿‡ IPNS)");
    println!("  6. âœ“ é€šè¿‡ DID ç›´æ¥éªŒè¯");
    println!("  7. âœ“ æ¼”ç¤ºèº«ä»½æ›´æ–°");
    
    println!("\nğŸ¯ æ ¸å¿ƒä¼˜åŠ¿ï¼š");
    println!("  â€¢ åªéœ€è°ƒç”¨ register_identity() å®Œæˆæ‰€æœ‰æ³¨å†Œæ­¥éª¤");
    println!("  â€¢ åªéœ€è°ƒç”¨ verify_identity() å®Œæˆæ‰€æœ‰éªŒè¯æ­¥éª¤");
    println!("  â€¢ DID â†” IPNS â†” CID è‡ªåŠ¨ç»‘å®š");
    println!("  â€¢ åŒå±‚éªŒè¯è‡ªåŠ¨å®Œæˆ");
    
    println!("\nğŸ’¡ ä¸‹ä¸€æ­¥ï¼š");
    println!("  â€¢ å¯†é’¥æ–‡ä»¶: {:?}", key_path);
    println!("  â€¢ DID: {}", registration.did);
    println!("  â€¢ IPNS: {}", registration.ipns_name);
    println!("  â€¢ å¯ä»¥åœ¨å…¶ä»–ç¨‹åºä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯è¿›è¡Œèº«ä»½éªŒè¯");
    
    Ok(())
}

